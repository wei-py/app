name: ğŸ Build iOS Debug (Staging)

on:
  push:
    branches:
      - staging

env:
  APP_ID: ${{ secrets.APP_ID }}
  APP_NAME: BTOLIGHT
  VERSION_NAME: 2.9.0
  BUILD_NUMBER: ${{ github.run_number }}
  BUILD_TYPE: debug
  TEAM_ID: ${{ secrets.TEAM_ID }}
  PROVISIONING_PROFILE_SPECIFIER: ${{ secrets.DEBUG_PROVISIONING_PROFILE_SPECIFIER }}
  CODE_SIGN_IDENTITY: "Apple Development"
  SIGNING_CERTIFICATE_P12_DATA: ${{ secrets.DEBUG_SIGNING_CERTIFICATE_P12_DATA }}
  SIGNING_CERTIFICATE_PASSWORD: ${{ secrets.DEBUG_SIGNING_CERTIFICATE_PASSWORD }}
  PROVISIONING_PROFILE_DATA: ${{ secrets.DEBUG_PROVISIONING_PROFILE_DATA }}

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js & pnpm
        uses: pnpm/action-setup@v4
        with:
          node-version: "22"
          version: "latest"

      - name: ğŸ“¦ Install dependencies
        run: |
          pnpm install --frozen-lockfile
          pnpm exec react-native config

      - name: ğŸ Setup CocoaPods
        run: |
          cd ios
          pod install --repo-update

      - name: ğŸš€ Install Bundler & Fastlane
        run: |
          gem install bundler
          bundle install

      - name: ğŸ” Import Certificate
        env:
          SIGNING_CERTIFICATE_P12_DATA: ${{ secrets.DEBUG_SIGNING_CERTIFICATE_P12_DATA }}
          SIGNING_CERTIFICATE_PASSWORD: ${{ secrets.DEBUG_SIGNING_CERTIFICATE_PASSWORD }}
        run: |
          exec .github/scripts/import-certificate.sh
          

      - name: ğŸ” Import Provisioning Profile
        env:
          PROVISIONING_PROFILE_DATA: ${{ secrets.DEBUG_PROVISIONING_PROFILE_DATA }}
        run: |
          exec .github/scripts/import-profile.sh

      - name: ğŸ—ï¸ Build IPA with Fastlane
        run: |
          cd ios
          bundle exec fastlane build_debug
        env:
          APP_ID: ${{ secrets.APP_ID }}
          TEAM_ID: ${{ secrets.TEAM_ID }}
          # ç®€åŒ–ç¯å¢ƒå˜é‡ï¼Œåªä¿ç•™å¿…è¦çš„
          PROVISIONING_PROFILE_SPECIFIER: ${{ secrets.DEBUG_PROVISIONING_PROFILE_SPECIFIER }}
          CODE_SIGN_IDENTITY: "Apple Development"

      - name: âœ… Check IPA exists
        run: |
          if [ ! -f "ios/build/export/app2.ipa" ]; then
            echo "âŒ IPA not found!"
            exit 1
          fi

      - name: ğŸ’¾ Upload Debug IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-ios-debug-ipa
          path: ios/build/export/app2.ipa
