# å·¥ä½œæµåç§°
name: ğŸ¤– Assemble Android Release

# è§¦å‘å·¥ä½œæµç¨‹çš„äº‹ä»¶
on:
  push:
    branches: [staging]
    tags: [v*]
  workflow_dispatch:
    inputs:
      version_name:
        description: 'ç‰ˆæœ¬åç§° (ä¾‹å¦‚: 2.0.0)'
        required: false
      version_code:
        description: 'ç‰ˆæœ¬å·'
        required: false

# å·¥ä½œæµç¯å¢ƒå˜é‡
env:
  # åº”ç”¨çš„application_id
  APP_ID: com.app2.app2
  # åº”ç”¨åç§°
  APP_NAME: app2
  # æ‰“åŒ…ç±»å‹
  BUILD_TYPE: release
  # ç‰ˆæœ¬åç§° - æ”¯æŒæ‰‹åŠ¨è¾“å…¥è¦†ç›–
  VERSION_NAME: ${{ github.event.inputs.version_name || '2.0.0' }}
  # ç‰ˆæœ¬å· - æ”¯æŒæ‰‹åŠ¨è¾“å…¥è¦†ç›–
  VERSION_CODE: ${{ github.event.inputs.version_code || '10' }}
  # å¯†é’¥åº“æ–‡ä»¶
  KEYSTORE_FILE: debug.keystore
  # å¯†é’¥åº“ç›¸å…³ä¿¡æ¯ - ç”Ÿäº§ç¯å¢ƒåº”ä½¿ç”¨ secrets
  KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD || 'android' }}
  KEYSTORE_KEY_ALIAS: ${{ secrets.KEYSTORE_KEY_ALIAS || 'androiddebugkey' }}
  KEYSTORE_KEY_PASSWORD: ${{ secrets.KEYSTORE_KEY_PASSWORD || 'android' }}

# å·¥ä½œæµä½œä¸š
jobs:
  assemble:
    name: æ„å»º Android åº”ç”¨
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½® Java ç¯å¢ƒ
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "17"
          cache: 'gradle'

      - name: è®¾ç½® PNPM
        uses: pnpm/action-setup@v2

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 22
          cache: "pnpm"

      - name: å®‰è£…ä¾èµ–
        run: pnpm install

      - name: è®¾ç½® Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: true
          working-directory: android

      - name: å®‰è£… Ruby ä¾èµ–
        working-directory: android
        run: |
          bundle config set --local deployment 'false'
          bundle config set --local path 'vendor/bundle'
          bundle install --retry=3 --jobs=4

      - name: æ„å»º Android ${{ env.BUILD_TYPE }}
        working-directory: android
        run: bundle exec fastlane assemble
        env:
          KEYSTORE_FILE: ${{ github.workspace }}/android/app/${{ env.KEYSTORE_FILE }}
          NODE_PATH: ${{ github.workspace }}/node_modules/.pnpm/node_modules:$NODE_PATH
          VERSION_NAME: ${{ env.VERSION_NAME }}
          VERSION_CODE: ${{ env.VERSION_CODE }}

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-${{ env.VERSION_NAME }}-${{ env.BUILD_TYPE }}
          path: ${{ github.workspace }}/android/app/build/outputs/apk/${{ env.BUILD_TYPE }}/app-${{ env.BUILD_TYPE }}.apk
          retention-days: 7

      - name: å‘å¸ƒåˆ° GitHub Releases
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          prerelease: ${{ contains(github.ref, 'beta') }}
          files: |
            android/app/build/outputs/apk/${{ env.BUILD_TYPE }}/app-${{ env.BUILD_TYPE }}.apk
          name: ${{ env.APP_NAME }} v${{ env.VERSION_NAME }} (${{ env.VERSION_CODE }})
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
