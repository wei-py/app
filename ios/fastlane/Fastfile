# ios/fastlane/Fastfile

default_platform :ios

platform :ios do
  desc "Build Debug IPA"
  lane :build_debug do
    # 确保正确的代码签名设置
    update_code_signing_settings(
      use_automatic_signing: false,
      path: "app2.xcodeproj",
      team_id: "N59966K35U",
      #  ENV["TEAM_ID"],
      code_sign_identity: "Apple Development",  # 使用完整的证书名称
      profile_name: "BTOLIGHTDev",  # 使用确切的配置文件名称
      bundle_identifier: "com.bto.Light",  # 使用确切的Bundle ID
      targets: ["app2"]  # 明确指定目标
    )
    
    gym(
      workspace: "app2.xcworkspace",  # 明确指定 workspace
      scheme: "app2",
      configuration: "Debug",
      export_method: "development",
      output_directory: "build/export",
      output_name: "app2.ipa",
      clean: true,
      include_bitcode: false,  # 禁用 bitcode
      include_symbols: true,
      export_options: {
        method: "development",
        provisioningProfiles: {
          "com.bto.Light" => "BTOLIGHTDev"  # 使用确切的值而不是环境变量
        },
        signingStyle: "manual",
        teamID: "N59966K35U",
        # ENV["TEAM_ID"],
        compileBitcode: false
      }
    )
  end

  desc "Build Release IPA"
  lane :build_release do
    update_code_signing_settings(
      use_automatic_signing: false,
      path: "app2.xcodeproj",
      team_id: ENV["TEAM_ID"],
      code_sign_identity: ENV["CODE_SIGN_IDENTITY"],
      profile_name: ENV["PROVISIONING_PROFILE_SPECIFIER"],
      bundle_identifier: ENV["APP_ID"],
      targets: ["app2"]
    )
    
    gym(
      workspace: "app2.xcworkspace",
      scheme: "app2",
      configuration: "Release",
      export_method: "app-store",
      output_directory: "build/export",
      output_name: "app2.ipa",
      clean: true,
      include_bitcode: false,
      include_symbols: true,
      export_options: {
        method: "app-store",
        provisioningProfiles: {
          ENV["APP_ID"] => ENV["PROVISIONING_PROFILE_SPECIFIER"]
        },
        signingStyle: "manual",
        signingCertificate: ENV["CODE_SIGN_IDENTITY"],
        teamID: ENV["TEAM_ID"],
        compileBitcode: false
      }
    )
  end
end