# å·¥ä½œæµåç§°
name: Assemble Android Release

# è§¦å‘å·¥ä½œæµç¨‹çš„äº‹ä»¶
on:
  push:
    branches: [main]
    tags: [v*]
  pull_request:
    branches: [main]

  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

# å·¥ä½œæµç¯å¢ƒå˜é‡
env:
  # åº”ç”¨çš„application_id (ä» Secrets è¯»å–ï¼Œæ›´å®‰å…¨)
  APP_ID: ${{ secrets.RELEASE_APP_ID }}
  # åº”ç”¨åç§°
  APP_NAME: TaroDemoRelease
  # æ‰“åŒ…ç±»å‹
  BUILD_TYPE: release
  # ç‰ˆæœ¬åç§° (å¯ä»¥ä» Tag ä¸­æå–ï¼Œä½†è¿™é‡Œå…ˆå†™æ­»)
  VERSION_NAME: 2.9.0
  # ç‰ˆæœ¬å·
  VERSION_CODE: 10
  # å¯†é’¥åº“æ–‡ä»¶
  KEYSTORE_FILE: debug.keystore
  # å¯†é’¥åº“å£ä»¤
  KEYSTORE_PASSWORD: android
  # å¯†é’¥åº“åˆ«å
  KEYSTORE_KEY_ALIAS: androiddebugkey
  # å¯†é’¥åº“åˆ«åå£ä»¤
  KEYSTORE_KEY_PASSWORD: android

# å·¥ä½œæµä½œä¸š
jobs:
  assemble:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Project
        uses: actions/checkout@v3

      - uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "17"

      - uses: pnpm/action-setup@v2
        with:
          version: 8

      - uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: "pnpm"

      - run: pnpm install

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: ~/.gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # ğŸ‘‡ ä½¿ç”¨ setup-rubyï¼Œé¿å…æƒé™é—®é¢˜
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"
          bundler-cache: true

      # ğŸ‘‡ æ›´æ–° strings.xmlï¼Œå’Œ Debug ä¿æŒä¸€è‡´
      - name: Update Android strings.xml
        run: |
          chmod +x .github/scripts/update_strings.sh
          ./.github/scripts/update_strings.sh

      # ğŸ‘‡ å…³é”®æ­¥éª¤ï¼šå°†ç­¾åæ–‡ä»¶ä» Secrets å†™å…¥ç£ç›˜
      - name: Prepare Keystore
        run: |
          mkdir -p android/app
          # å°† Base64 ç¼–ç çš„å¯†é’¥åº“æ–‡ä»¶è§£ç å¹¶ä¿å­˜
          echo "${{ secrets.RELEASE_KEYSTORE_FILE }}" | base64 -d > android/app/release.keystore
          # è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œä¾› Gradle ä½¿ç”¨
          echo "KEYSTORE_FILE=${{ github.workspace }}/android/app/release.keystore" >> $GITHUB_ENV

      # ğŸ‘‡ æ„å»º Release åŒ… (ä½¿ç”¨ ./gradlewï¼Œæœ€ç¨³å®š)
      - name: Assemble Android ${{ env.BUILD_TYPE }}
        run: |
          cd android
          ./gradlew assemble${{ env.BUILD_TYPE }} --no-daemon
        env:
          # ä» Secrets è¯»å–ç­¾åä¿¡æ¯
          KEYSTORE_PASSWORD: ${{ secrets.RELEASE_KEYSTORE_PASSWORD }}
          KEYSTORE_KEY_ALIAS: ${{ secrets.RELEASE_KEY_ALIAS }}
          KEYSTORE_KEY_PASSWORD: ${{ secrets.RELEASE_KEY_PASSWORD }}
          NODE_PATH: ${{ github.workspace }}/node_modules/.pnpm/node_modules:$NODE_PATH

      # ğŸ‘‡ ä¸Šä¼ äº§ç‰©åˆ° Actions
      - name: Upload Android Products
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ env.BUILD_TYPE }}
          path: ${{ github.workspace }}/android/app/build/outputs/apk/${{ env.BUILD_TYPE }}/app-${{ env.BUILD_TYPE }}.apk

      # ğŸ‘‡ è‡ªåŠ¨åˆ›å»º GitHub Release
      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          prerelease: ${{ contains(github.ref, 'beta') }}
          files: |
            android/app/build/outputs/apk/${{ env.BUILD_TYPE }}/app-${{ env.BUILD_TYPE }}.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
